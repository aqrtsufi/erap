import{C as e,D as t,E as n,F as r,I as i,L as a,M as o,N as s,O as c,P as l,R as u,T as d,_ as f,b as p,f as ee,g as te,h as ne,k as re,m,p as ie,t as ae,u as oe,v as h,w as g,x as _,z as v}from"./vendor-BQYTT8JO.js";import{t as y}from"./search-CKcgQAWs.js";import{a as se,d as b,i as ce,l as le,o as ue,p as de,s as x,t as fe,u as pe}from"./storage-KKhvUxvV.js";import{t as me}from"./epub-37iu7sur.js";function he(e){let t=e.classList.contains(`noteref`)||e.classList.contains(`footnote-ref`)||e.classList.contains(`footnoteRef`)||e.classList.contains(`endnote`)||e.classList.contains(`endnote-ref`),n=e.getAttribute(`role`)===`doc-noteref`,r=(e.getAttribute(`epub:type`)||``).split(/\s+/).includes(`noteref`),i=(e.getAttribute(`rel`)||``).split(/\s+/).includes(`footnote`),a=e.getAttribute(`href`)||``,o=a.includes(`#`)&&/#(fn[-_]?|footnote|note|endnote)/i.test(a);return t||n||r||i||o}async function S(e){let t=e.trim();if(!t)return null;try{let e=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(t)}`);if(!e.ok)return null;let n=await e.json(),r=[];for(let e of n||[])for(let t of e.meanings||[])for(let e of t.definitions||[])e.definition&&r.push(e.definition);return r.length?r.slice(0,6).join(`
`):null}catch{return null}}function ge(e,t,n){return(e||``).trim().replace(/\s+/g,` `).toLowerCase()===`the quran`?`quran`:`default`}function _e(e,t){let n=(t.title||``).trim().replace(/\s+/g,` `).replace(/[.]\s*$/,``),r=(t.section??t.chapter)?.trim(),i=t.verseHint?` (${t.verseHint})`:``;return e===`quran`?`${t.author?`Translated by ${t.author}`:`Translation`}. ${n}${r?`. ${r}`:``}${i}.`.replace(/\s+/g,` `).trim():`${t.author?`${t.author}. `:``}${n}${r?`. ${r}`:``}${i}.`.replace(/\s+/g,` `).trim()}function C(e){let t=e.match(/^\s*(\d{1,3}\s*[:.]\s*\d{1,3})\b/)?.[1];if(t)return t.replace(/\s+/g,``);let n=e.match(/^\s*(\d{1,4})\b/)?.[1];if(n)return n}function ve(e){let t=C(e.selectedText),n=_e(e.profile,{title:e.title,author:e.author,section:e.section??e.chapter,verseHint:t});return`"${e.selectedText.trim()}"\n\n— ${n}`}var w=3;function ye(){return new y.Index({tokenize:`forward`,resolution:9,cache:100})}function T(e){return(e||``).replace(/\s+/g,` `).trim()}function be(e,t){let n=T(e),r=n.toLowerCase().indexOf(t.toLowerCase());if(r<0)return n.slice(0,180)+(n.length>180?`…`:``);let i=Math.max(0,r-60),a=Math.min(n.length,r+t.length+100);return(i>0?`…`:``)+n.slice(i,a)+(a<n.length?`…`:``)}function xe(e){if(e&&typeof e==`object`&&e.nodeType===9){let t=e;return T(t.body?.textContent||t.documentElement?.textContent||``)}let t=typeof e==`string`?e:String(e??``),n=new DOMParser,r=n.parseFromString(t,`application/xhtml+xml`);return r.getElementsByTagName(`parsererror`).length&&(r=n.parseFromString(t,`text/html`)),T(r.body?.textContent||r.documentElement?.textContent||``)}async function Se(e,t,n){let r=ye(),i=await x(e),a=i?.hrefText??{},o=i?.v,s=Object.values(a).reduce((e,t)=>e+(t?.length||0),0);(o!==w||s<500)&&(a={});let c=Object.keys(a);if(c.length>0){for(let e of c){let t=a[e];t&&r.add(e,t.toLowerCase())}return n?.(c.length,c.length,!0),{idx:r,hrefText:a,fromCache:!0}}let l=t?.spine?.items??[],u=l.length;for(let e=0;e<l.length;e++){let i=l[e]?.href;if(!i){n?.(e+1,u,!1);continue}try{let e=xe(await t.load(i));e&&(a[i]=e,r.add(i,e.toLowerCase()))}catch{}n?.(e+1,u,!1),e%3==0&&await new Promise(e=>setTimeout(e,0))}return await b(e,{v:w,hrefText:a,updatedAt:Date.now()}),{idx:r,hrefText:a,fromCache:!1}}function Ce(e,t,n){let r=n.trim();return r?e.search(r.toLowerCase(),30).map(e=>typeof e==`string`?e:e.href).filter(Boolean).map(e=>({href:e,snippet:be(t[e]||``,r)})):[]}var E=`universal_reader_db`,D=1;async function O(){return ae(E,D,{upgrade(e){e.createObjectStore(`books`,{keyPath:`id`}),e.createObjectStore(`prefs`,{keyPath:`bookId`}),e.createObjectStore(`sessions`,{keyPath:`id`}),e.createObjectStore(`search`,{keyPath:`bookId`}),e.createObjectStore(`meta`,{keyPath:`key`})}})}async function k(e){await(await O()).put(`sessions`,e)}async function A(e){return(await(await O()).getAll(`sessions`)).filter(t=>t.bookId===e)}function j(){return crypto.randomUUID?.()??`${Date.now()}-${Math.random()}`}async function we(e){let t={id:j(),bookId:e,startAt:Date.now()};return await k(t),t}async function Te(e,t,n){let r=await(await O()).get(`sessions`,t);if(!r||r.bookId!==e)return;let i=Date.now(),a=Math.max(0,Math.round((i-r.startAt)/1e3));await k({...r,endAt:i,seconds:a,lastHref:n??r.lastHref})}async function Ee(e){let t=await A(e);return{totalSeconds:t.reduce((e,t)=>e+(t.seconds??0),0),totalSessions:t.filter(e=>e.endAt).length}}function De(e){return String(e??``).replace(/\s+/g,` `).trim()}var Oe={class:`h-full bg-base-100`},ke={key:0,class:`fixed top-0 left-0 right-0 z-30 bg-base-200/95 backdrop-blur border-b border-base-300`},Ae={class:`navbar`},je={class:`flex-1 min-w-0`},Me={class:`ml-2 truncate font-semibold`},Ne={class:`px-3 pb-3`},Pe={key:0,class:`text-xs opacity-60 mt-1`},Fe={key:1,class:`text-xs opacity-60 mt-1`},Ie={key:2,class:`mt-2 max-h-56 overflow-auto bg-base-100 rounded-xl border border-base-300`},Le={class:`max-h-64 overflow-auto border border-base-300 rounded-md`},Re=[`onClick`],ze={class:`text-xs opacity-60`},Be={class:`text-sm`},Ve={class:`p-3 grid grid-cols-2 sm:grid-cols-4 gap-3`},He={class:`form-control`},Ue={class:`form-control`},We={class:`form-control`},Ge={class:`form-control`},Ke={class:`form-control col-span-2`},qe={class:`form-control col-span-2`},Je={class:`form-control col-span-2`},Ye={class:`form-control`},Xe={class:`form-control`},Ze={class:`flex items-center gap-2 cursor-pointer`},Qe={class:`flex items-center gap-2 cursor-pointer`},$e={key:4,class:`modal modal-open`},et={class:`modal-box max-w-2xl`},tt={class:`mt-4 max-h-[70vh] overflow-auto space-y-1`},nt=[`onClick`],rt={class:`text-xs opacity-70 mt-2`},it={key:0},at={key:1},ot={key:0,class:`mt-3 text-sm opacity-70`},st={key:1,class:`mt-3 max-h-80 overflow-auto bg-base-100 rounded-xl border border-base-300`},ct=[`onClick`],lt={class:`text-xs opacity-60`},ut={class:`text-sm`},dt={key:0,class:`opacity-70`},ft=[`innerHTML`],M=g({__name:`ReaderView`,props:{id:{}},setup(ae){let g=r(fe),y=ae,b=oe(),x=r(!1),_e=r(null),C=r(null),w=r(24);function T(){x.value=!0,d(()=>_e.value?.focus())}function be(){x.value=!1}let xe=r(null),E=r(!0),D=r(null),O=r(`default`),k=0,A=r(!1),j=r(``),M=r([]),N=r(!1),pt=r(0),P=r(0),F=r(!1),I=r(null),L=r(!1),mt=r([]),ht=f(()=>{let e=[],t=(n,r)=>{for(let i of n??[])i?.href&&e.push({href:i.href,label:i.label||i.href,depth:r}),i?.subitems?.length&&t(i.subitems,r+1)};return t(mt.value,0),e});function gt(){L.value=!0}function _t(){L.value=!1}async function vt(e){_t(),E.value=!0,await Vt(e.href)}function yt(e){e.key===`Escape`&&(E.value=!0,L.value=!1,x.value=!1),(e.key===`t`||e.key===`T`)&&E.value&&(L.value=!L.value)}function bt(e,t){let n=t.trim();if(!n)return null;let r=[],i=e.createTreeWalker(e.body,NodeFilter.SHOW_TEXT);for(;i.nextNode();){let e=i.currentNode;e.data&&e.data.trim()&&r.push(e)}let a=r.map(e=>e.data).join(``).toLowerCase().indexOf(n.toLowerCase());if(a<0)return null;let o=a+n.length,s=null,c=null,l=0,u=0,d=0;for(let e of r){let t=e.data.length;if(!s&&a<d+t&&(s=e,l=a-d),!c&&o<=d+t){c=e,u=o-d;break}d+=t}if(!s)return null;c||(c=s,u=Math.min(s.data.length,l+n.length));let f=e.createRange();return f.setStart(s,Math.max(0,l)),f.setEnd(c,Math.max(0,u)),f}async function xt(e,t){let n=e?.document;if(!n?.body)return;let r=bt(n,t);if(!r)return;let i=r.getBoundingClientRect(),a=e.window,o=a.scrollY+i.top-a.innerHeight*.33;a.scrollTo({top:Math.max(0,o),behavior:`instant`});try{r.startContainer?.parentElement?.scrollIntoView?.({block:`center`})}catch{}}async function St(e){let t=j.value.trim();if(jt(),E.value=!0,!t){await K.display(e.href);return}I.value={href:e.href,query:t},await K.display(e.href)}let R=null,z={},B=r(!1),V=r(``),H=r(``),U=r(null),W=r(!1),G=null,K=null,q=null,Ct=f(()=>E.value?`pt-24`:`pt-0`),wt=f(()=>E.value?`pb-32`:`pb-0`),Tt={},Et=!1;function J(e){let t=decodeURIComponent(e||``).replace(/^#/,``).trim(),n=t.replace(/^fn-/,``),r=new Set([t,n,`fn-${n}`,t.replace(/_/g,`-`),t.replace(/-/g,`_`),n.replace(/_/g,`-`),n.replace(/-/g,`_`),`fn-${n.replace(/_/g,`-`)}`,`fn-${n.replace(/-/g,`_`)}`]);for(let e of Array.from(r))r.add(e.toLowerCase());return[...r].filter(Boolean)}function Dt(e){if(e&&typeof e==`object`&&e.nodeType===9)return e;let t=typeof e==`string`?e:String(e??``),n=new DOMParser().parseFromString(t,`application/xhtml+xml`);return n.getElementsByTagName(`parsererror`).length&&(n=new DOMParser().parseFromString(t,`text/html`)),n}function Ot(e){let t=window.CSS;return t?.escape?t.escape(e):e.replace(/([ !"#$%&'()*+,./:;<=>?@[\\\]^`{|}~])/g,`\\$1`)}function kt(e,t){return e.getElementById(t)??e.querySelector(`#${Ot(t)}`)??null}async function At(){if(Et||!G)return;Et=!0;let e=new Set;for(let t of G.spine?.items??[])t?.href&&e.add(Q(t.href));let t=G?.packaging?.manifest??G?.manifest;if(t&&typeof t==`object`)for(let n of Object.keys(t)){let r=t[n],i=r?.href,a=r?.type||r?.media_type||r?.mediaType;i&&(!a||/x?html/i.test(a))&&e.add(Q(i))}for(let t of e){let e;try{e=await Promise.race([G.load(t),new Promise((e,t)=>setTimeout(()=>t(Error(`book.load timeout`)),2500))])}catch{continue}let n=Dt(e),r=new Set;n.querySelectorAll(`#inline-footnotes [id]`).forEach(e=>r.add(e)),n.querySelectorAll(`.footnote[id]`).forEach(e=>r.add(e)),n.querySelectorAll(`[role="doc-footnote"][id]`).forEach(e=>r.add(e)),n.querySelectorAll(`[epub\\:type~="footnote"][id]`).forEach(e=>r.add(e));for(let e of r){let n=e.getAttribute(`id`)||``;if(!n)continue;let r=e.cloneNode(!0),i=r.querySelector(`.sr-only strong`)?.textContent?.trim()||r.querySelector(`.sr-only`)?.textContent?.trim()||void 0;r.querySelectorAll(`.sr-only`).forEach(e=>e.remove()),r.querySelectorAll(`script, iframe, object, embed`).forEach(e=>e.remove());let a=`<div class="space-y-2 leading-relaxed">${r.innerHTML}</div>`;for(let e of J(n))Tt[e]={title:i,html:a,href:t}}}}function Y(e,t){V.value=e,H.value=t,B.value=!0}function jt(){B.value=!1}function Mt(e){let t=e.target?.closest?.(`a`)??null;if(!t)return;let n=t.getAttribute(`href`)||``;if(n){if(Lt(n)||he(t)){e.preventDefault();let r=U.value||K?.location?.start?.href||D.value?.lastHref||``;Nt(n,(t.textContent||``).trim(),r);return}/^(https?:|mailto:|tel:)/i.test(n)||(e.preventDefault(),Vt(n))}}async function Nt(e,t,n){let[r,i]=e.split(`#`),a=(r||``).trim(),o=(i||``).trim();if(!o)return;let s=Z(o).replace(/^#/,``);W.value=!0,V.value=`Loading…`,H.value=``;try{let{doc:e,hrefUsed:r}=await Wt(a,null,n);for(let i of J(s)){let a=kt(e,i);if(a){let e=a.cloneNode(!0),i=e.querySelector(`.sr-only strong`)?.textContent?.trim()||e.querySelector(`.sr-only`)?.textContent?.trim()||t||s;e.querySelectorAll(`.sr-only`).forEach(e=>e.remove()),e.querySelectorAll(`script, iframe, object, embed`).forEach(e=>e.remove()),V.value=i,H.value=`<div class="space-y-2 leading-relaxed">${e.innerHTML}</div>`,U.value=r||n;return}}await At();for(let e of J(s)){let r=Tt[e];if(r){V.value=r.title||t||s,H.value=r.html,U.value=r.href||n;return}}let i=s.replace(/^fn-/,``),o=await S(i);V.value=t||i,H.value=o?`<pre class="whitespace-pre-wrap">${$(o)}</pre>`:`<p>No definition found.</p>`}finally{W.value=!1}}async function Pt(){q&&await Te(y.id,q),b.push(`/`)}function X(){if(!K)return;let e=g.value.noterefUnderline?`underline`:`none`;K.themes.register(`user`,{body:{background:g.value.bg,color:g.value.fg,"font-family":g.value.font,"line-height":String(g.value.lineHeight),margin:`${g.value.marginEm}em`,"text-align":`${g.value.textAlign} !important`,"padding-bottom":`${w.value}px`},p:{"text-align":`${g.value.textAlign} !important`},'a.noteref, a[role="doc-noteref"], a[rel~="footnote"], a[epub\\:type~="noteref"]':{color:g.value.noterefColor,"text-decoration":`${e} !important`}}),K.themes.select(`user`),K.themes.fontSize(`${g.value.fontSizePct}%`)}function Ft(){E.value=!E.value}function Z(e){try{return decodeURIComponent(e)}catch{return e}}function Q(e){let t=(e||``).replace(/\\/g,`/`).replace(/\/+/g,`/`).replace(/^\/+/g,``),n=[];for(let e of t.split(`/`))!e||e===`.`||(e===`..`?n.pop():n.push(e));return n.join(`/`)}function It(e,t){let n=(e||``).replace(/\/+/g,`/`).replace(/\/+$/g,``),r=(t||``).replace(/\/+/g,`/`).replace(/^\/+/g,``);return Q(n?`${n}/${r}`:r)}function Lt(e){return!!e&&e.includes(`#`)&&/#(fn[-_]?|footnote|note|endnote)/i.test(e)}async function Rt(){await d();let e=E.value&&C.value?C.value.offsetHeight:0;w.value=Math.max(24,e+24),X()}o(E,()=>Rt()),t(()=>window.addEventListener(`resize`,Rt)),n(()=>window.removeEventListener(`resize`,Rt));async function zt(e){let t=await se(),n=t.findIndex(e=>e.id===y.id);if(n<0)return;let r=t[n];r&&(t[n]={...r,...e},await le(t),D.value=t[n]??null)}async function Bt(){if(!G)return{idx:ye(),hrefText:{},fromCache:!1};A.value=!0,N.value=!1;try{console.info(`[search] init`,{spine:G.spine?.items?.length??0});let e=await Se(y.id,G,(e,t,n)=>{pt.value=e,P.value=t,F.value=n});R=e.idx,z=e.hrefText;let t=Object.values(z).reduce((e,t)=>e+(t?.length||0),0),n=Object.entries(z)[0];console.info(`[search] text`,{totalChars:t,firstHref:n?.[0],firstSample:n?.[1]?.slice(0,120)}),N.value=!0,M.value=j.value.trim()?Ce(R,z,j.value.trim()):[],console.info(`[search] ready`,{chapters:Object.keys(z).length,fromCache:e.fromCache}),window.__readerDebug={status:()=>({ready:N.value,done:pt.value,total:P.value,fromCache:F.value,chapters:Object.keys(z).length}),search:e=>R?Ce(R,z,e):[]}}catch(e){console.error(`[search] failed`,e)}finally{A.value=!1}}o(j,()=>{let e=j.value.trim();if(!e||!N.value||!R){M.value=[];return}M.value=Ce(R,z,e)}),o(E,()=>X());async function Vt(e){jt(),E.value=!0,await K.display(e)}async function Ht(){let e=await Ee(y.id);Y(`Reading analytics`,`<p>Total: <b>${Math.round(e.totalSeconds/60)}</b> minutes across <b>${e.totalSessions}</b> sessions.</p>`)}function Ut(e,t,n){let r=Z(t||``).trim(),i=Z(e||``).trim(),a=Q(r),o=Q(i),s=o.includes(`/`)?o.slice(0,o.lastIndexOf(`/`)+1):``,c=new Set;a&&c.add(It(s,a)),a&&c.add(a);let l=[];for(let e of n?.spine?.items??[]){let t=e?.href;t&&l.push(Q(t))}let u=n?.packaging?.manifest??n?.manifest;if(u&&typeof u==`object`)for(let e of Object.keys(u)){let t=u[e],n=t?.href,r=t?.type||t?.media_type||t?.mediaType;n&&(!r||/x?html/i.test(r))&&l.push(Q(n))}let d=a.split(`/`).pop()||a;for(let e of l)e&&(e===a||e.endsWith(`/`+a)||e.endsWith(`/`+d)||e===d)&&c.add(e);return[...c]}async function Wt(e,t,n){let r=n||K?.location?.start?.href||D.value?.lastHref||``;if(!e)return t?{doc:t,hrefUsed:r}:r?{doc:Dt(await Promise.race([G.load(r),new Promise((e,t)=>setTimeout(()=>t(Error(`book.load timeout`)),2500))])),hrefUsed:r}:{doc:document.implementation.createHTMLDocument(``),hrefUsed:``};let i=Ut(r,e,G),a=null;for(let e of i)try{return{doc:Dt(await Promise.race([G.load(e),new Promise((e,t)=>setTimeout(()=>t(Error(`book.load timeout`)),2500))])),hrefUsed:e}}catch(e){a=e}throw a??Error(`Could not load referenced file`)}async function Gt(e,t,n){let r=e.getAttribute(`href`)||``,i=(e.textContent||``).trim();if(!r||/^(https?:|mailto:|tel:)/i.test(r))return;let[a,o]=r.split(`#`),s=(a||``).trim(),c=(o||``).trim();if(!c)return;let l=Z(c).replace(/^#/,``);W.value=!0,B.value=!0,V.value=`Loading…`,H.value=``,U.value=null;let u=(e,t,n)=>{let r=e.cloneNode(!0),a=t||r.querySelector(`.sr-only strong`)?.textContent?.trim()||r.querySelector(`.sr-only`)?.textContent?.trim()||i||l;r.querySelectorAll(`.sr-only`).forEach(e=>e.remove()),r.querySelectorAll(`script, iframe, object, embed`).forEach(e=>e.remove()),V.value=a,H.value=`<div class="space-y-2 leading-relaxed">${r.innerHTML}</div>`,U.value=n};try{for(let e of J(l)){let r=kt(t,e);if(r){u(r,void 0,n||K?.location?.start?.href||D.value?.lastHref||``);return}}try{let{doc:e,hrefUsed:r}=await Wt(s,s?null:t,n);for(let t of J(l)){let i=kt(e,t);if(i){u(i,void 0,r||n);return}}}catch{}await At();for(let e of J(l)){let t=Tt[e];if(t){V.value=t.title||i||l,H.value=t.html,U.value=t.href||n;return}}let e=l.replace(/^fn-/,``),r=await S(e);V.value=i||e,H.value=r?`<pre class="whitespace-pre-wrap">${$(r)}</pre>`:`<p>No definition found.</p>`}finally{W.value=!1}}function $(e){return e.replace(/[&<>"']/g,e=>({"&":`&amp;`,"<":`&lt;`,">":`&gt;`,'"':`&quot;`,"'":`&#39;`})[e])}async function Kt(e){try{let t=await G.getRange(e),n=De(t?.toString());if(!n)return;let r=qt(t)??await Jt(),i=(O.value===`quran`?qt(t,e=>/^sura\b/i.test(e))??void 0:void 0)??r,a=ve({profile:O.value,selectedText:n,title:D.value?.title||`Untitled`,author:D.value?.author,section:i,chapter:i});Y(`Selection`,`
          <p class="opacity-70">${$(n)}</p>
          <div class="mt-3 flex flex-wrap gap-2">
            <button id="btn-quote" class="btn btn-primary btn-sm">Copy quote</button>
            <button id="btn-define" class="btn btn-outline btn-sm">Define first word</button>
          </div>
        `),setTimeout(()=>{let e=document.getElementById(`btn-quote`),t=document.getElementById(`btn-define`);e?.addEventListener(`click`,async()=>{await navigator.clipboard.writeText(a),Y(`Copied`,`<p>Quote copied with citation.</p>`)}),t?.addEventListener(`click`,async()=>{let e=n.split(/\s+/)[0]||``,t=await S(e);Y(`Define: ${$(e)}`,t?`<pre class="whitespace-pre-wrap">${$(t)}</pre>`:`<p>No definition found.</p>`)})},0)}catch{}}function qt(e,t){let n=K?.location?.start?.href||D.value?.lastHref;if(!n)return;let r=n.split(`#`)[0],i=ht.value.filter(e=>(e.href||``).split(`#`)[0]===r);if(!i.length)return;let a=e.startContainer?.ownerDocument;if(a){let n=null;for(let r of i){if(t&&!t(r.label))continue;let i=(r.href||``).split(`#`)[1];if(!i)continue;let o=a.getElementById(i);if(o)try{let t=a.createRange();t.selectNode(o),t.compareBoundaryPoints(Range.START_TO_START,e)<=0&&(!n||r.depth>n.depth||n&&r.depth===n.depth)&&(n=r)}catch{}}if(n)return n.label}let o=t?i.filter(e=>t(e.label)):i;if(!o.length)return;let s=o[0];for(let e of o)(e.depth>s.depth||e.depth===s.depth)&&(s=e);return s.label}async function Jt(){try{let e=K?.location?.start?.href;return(G?.navigation?.toc??[]).find(t=>t.href&&e&&t.href.split(`#`)[0]===e.split(`#`)[0])?.label??void 0}catch{return}}async function Yt(){let e=(await se()).find(e=>e.id===y.id)||null;if(D.value=e,!e){b.push(`/`);return}let t=await ce(y.id);if(!t){b.push(`/`);return}G=me(await t.arrayBuffer()),await G.ready,mt.value=G.navigation?.toc??[],G.spine.hooks.serialize.register(e=>e.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,``));let n=await G.loaded.metadata,r=De(n?.title)||e.title,i=De(n?.creator)||e.author||``,a=``;try{let e=G.spine.items?.[0]?.href,t=await G.load(e);a=(new DOMParser().parseFromString(String(t),`text/html`).body?.textContent||``).slice(0,6e3)}catch{}O.value=ge(r,i,a),await zt({title:r,author:i,profile:O.value}),K=G.renderTo(xe.value,{width:`100%`,height:`100%`,spread:`none`,manager:`continuous`,flow:`scrolled-doc`}),K.on(`rendered`,async(e,t)=>{let n=I.value;if(!n)return;let r=(e?.href||``).split(`#`)[0],i=(n.href||``).split(`#`)[0];!r||r!==i||(I.value=null,await xt(t,n.query))}),K.hooks.content.register(e=>{let t=e.document;t.querySelectorAll(`script`).forEach(e=>e.remove());try{e.addStylesheetRules({"#inline-footnotes":{display:`none !important`},".sr-only":{display:`none !important`}})}catch{}t.addEventListener(`click`,async n=>{let r=n.target?.closest?.(`a`);if(r){if(r&&he(r)){n.preventDefault(),n.stopPropagation(),await Gt(r,t,e?.section?.href||K?.location?.start?.href||D.value?.lastHref||``);return}if(g.value.studyMode&&!r){let e=t.getSelection?.();if(e&&e.toString().trim())return;let r=Date.now();if(r-k<250)return;k=r,E.value=!E.value,n.preventDefault(),n.stopPropagation()}}},!0)}),K.on(`selected`,e=>Kt(e)),K.on(`relocated`,async e=>{let t=e?.start?.cfi,n=e?.start?.href,r=e?.start?.percentage;await zt({lastCfi:t,lastHref:n,lastProgress:r})}),await K.display(e.lastCfi||void 0),X(),q=(await we(y.id)).id,Bt()}return o(()=>g.value.studyMode,e=>{e?E.value=!1:E.value=!0}),o(g,async()=>{await pe(y.id,g.value),X()},{deep:!0}),t(async()=>{window.addEventListener(`keydown`,yt),g.value=await ue(y.id).catch(()=>fe),await Yt()}),n(async()=>{window.removeEventListener(`keydown`,yt);try{K&&K.destroy()}catch{}try{G&&G.destroy?.()}catch{}if(K=null,G=null,q)try{await Te(y.id,q)}catch{}}),(t,n)=>(c(),_(`div`,Oe,[E.value?(c(),_(`div`,ke,[h(`div`,Ae,[h(`div`,je,[h(`button`,{class:`btn btn-ghost btn-sm`,onClick:Pt},`← Library`),h(`div`,Me,v(D.value?.title),1)]),h(`div`,{class:`flex-none gap-2`},[h(`button`,{class:`btn btn-sm`,onClick:gt},`TOC`),h(`button`,{class:`btn btn-sm btn-outline`,onClick:Ht},`Stats`)])]),h(`div`,Ne,[l(h(`input`,{class:`input input-bordered w-full`,placeholder:`Search in book…`,"onUpdate:modelValue":n[0]||=e=>j.value=e},null,512),[[m,j.value]]),A.value?(c(),_(`div`,Pe,` Indexing `+v(pt.value)+`/`+v(P.value)+`… `,1)):N.value?(c(),_(`div`,Fe,` Search ready (`+v(Object.keys(i(z)).length)+` chapters`+v(F.value?`, cached`:``)+`) `,1)):p(``,!0),M.value.length?(c(),_(`div`,Ie,[h(`div`,Le,[(c(!0),_(te,null,re(M.value,e=>(c(),_(`div`,{key:e.href,class:`p-2 hover:bg-base-200 cursor-pointer`,onClick:t=>St(e)},[h(`div`,ze,v(e.href),1),h(`div`,Be,v(e.snippet),1)],8,Re))),128))])])):p(``,!0)])])):p(``,!0),h(`div`,{class:a([[Ct.value,wt.value],`h-full`]),onClick:Ft},[h(`div`,{ref_key:`viewer`,ref:xe,class:`h-full w-full`},null,512)],2),E.value?(c(),_(`div`,{key:1,ref_key:`bottomChromeEl`,ref:C,class:`fixed bottom-0 left-0 right-0 z-30 bg-base-200/95 backdrop-blur border-t border-base-300`,onClick:n[10]||=ne(()=>{},[`stop`])},[h(`div`,Ve,[h(`label`,He,[n[13]||=h(`div`,{class:`label`},[h(`span`,{class:`label-text`},`Font size`)],-1),l(h(`input`,{type:`range`,min:`80`,max:`180`,step:`5`,"onUpdate:modelValue":n[1]||=e=>g.value.fontSizePct=e,class:`range range-sm`},null,512),[[m,g.value.fontSizePct,void 0,{number:!0}]])]),h(`label`,Ue,[n[14]||=h(`div`,{class:`label`},[h(`span`,{class:`label-text`},`Line height`)],-1),l(h(`input`,{type:`range`,min:`1.2`,max:`2.2`,step:`0.05`,"onUpdate:modelValue":n[2]||=e=>g.value.lineHeight=e,class:`range range-sm`},null,512),[[m,g.value.lineHeight,void 0,{number:!0}]])]),h(`label`,We,[n[15]||=h(`div`,{class:`label`},[h(`span`,{class:`label-text`},`Background`)],-1),l(h(`input`,{type:`color`,"onUpdate:modelValue":n[3]||=e=>g.value.bg=e,class:`input input-bordered h-10 p-1`},null,512),[[m,g.value.bg]])]),h(`label`,Ge,[n[16]||=h(`div`,{class:`label`},[h(`span`,{class:`label-text`},`Text`)],-1),l(h(`input`,{type:`color`,"onUpdate:modelValue":n[4]||=e=>g.value.fg=e,class:`input input-bordered h-10 p-1`},null,512),[[m,g.value.fg]])]),h(`label`,Ke,[n[18]||=h(`div`,{class:`label`},[h(`span`,{class:`label-text`},`Font`)],-1),l(h(`select`,{class:`select select-bordered`,"onUpdate:modelValue":n[5]||=e=>g.value.font=e},[...n[17]||=[h(`option`,{value:`ui-serif, Georgia, "Times New Roman", Times, serif`},`Serif`,-1),h(`option`,{value:`ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`},`Sans`,-1),h(`option`,{value:`ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace`},`Mono`,-1)]],512),[[ie,g.value.font]])]),h(`label`,qe,[n[20]||=h(`div`,{class:`label`},[h(`span`,{class:`label-text`},`Alignment`)],-1),l(h(`select`,{class:`select select-bordered`,"onUpdate:modelValue":n[6]||=e=>g.value.textAlign=e},[...n[19]||=[h(`option`,{value:`left`},`Left`,-1),h(`option`,{value:`justify`},`Justify`,-1),h(`option`,{value:`center`},`Center`,-1),h(`option`,{value:`right`},`Right`,-1)]],512),[[ie,g.value.textAlign]])]),h(`label`,Je,[h(`label`,Ye,[n[21]||=h(`div`,{class:`label`},[h(`span`,{class:`label-text`},`Glossary link color`)],-1),l(h(`input`,{type:`color`,"onUpdate:modelValue":n[7]||=e=>g.value.noterefColor=e,class:`input input-bordered h-10 p-1`},null,512),[[m,g.value.noterefColor]])]),h(`label`,Xe,[n[23]||=h(`div`,{class:`label`},[h(`span`,{class:`label-text`},`Underline glossary links`)],-1),h(`label`,Ze,[l(h(`input`,{type:`checkbox`,class:`toggle`,"onUpdate:modelValue":n[8]||=e=>g.value.noterefUnderline=e},null,512),[[ee,g.value.noterefUnderline]]),n[22]||=h(`span`,{class:`text-sm opacity-70`},`Toggle`,-1)])]),n[25]||=h(`div`,{class:`label`},[h(`span`,{class:`label-text`},`Study mode`)],-1),h(`label`,Qe,[l(h(`input`,{type:`checkbox`,class:`toggle`,"onUpdate:modelValue":n[9]||=e=>g.value.studyMode=e},null,512),[[ee,g.value.studyMode]]),n[24]||=h(`span`,{class:`text-sm opacity-70`},`Hide UI (tap screen to show/hide)`,-1)])])])],512)):p(``,!0),E.value?p(``,!0):(c(),_(`button`,{key:2,class:`fixed z-50 btn btn-sm btn-circle`,style:{top:`calc(env(safe-area-inset-top) + 0.75rem)`,right:`3.25rem`},onClick:ne(T,[`stop`]),"aria-label":`Search`},[...n[26]||=[h(`svg`,{xmlns:`http://www.w3.org/2000/svg`,class:`h-4 w-4`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,"stroke-width":`2`},[h(`circle`,{cx:`11`,cy:`11`,r:`7`}),h(`path`,{d:`M21 21l-4.3-4.3`})],-1)]])),E.value?p(``,!0):(c(),_(`button`,{key:3,class:`fixed z-50 btn btn-sm opacity-80 hover:opacity-100`,style:{top:`calc(env(safe-area-inset-top) + 0.75rem)`,right:`0.75rem`},onClick:n[11]||=e=>E.value=!0,"aria-label":`Show controls`},` Show controls `)),L.value?(c(),_(`div`,$e,[h(`div`,et,[h(`div`,{class:`flex items-center justify-between gap-3`},[n[27]||=h(`h3`,{class:`font-bold text-lg`},`Table of contents`,-1),h(`button`,{class:`btn btn-sm`,onClick:_t},`Close`)]),h(`div`,tt,[(c(!0),_(te,null,re(ht.value,(e,t)=>(c(),_(`button`,{key:t,class:`btn btn-ghost btn-sm w-full justify-start text-left`,style:u({paddingLeft:`${e.depth*.75}rem`}),onClick:t=>vt(e)},v(e.label),13,nt))),128))])]),h(`div`,{class:`modal-backdrop`,onClick:_t})])):p(``,!0),e(de,{open:x.value,title:`Search`,onClose:be},{default:s(()=>[l(h(`input`,{ref_key:`searchInputEl`,ref:_e,class:`input input-bordered w-full`,placeholder:`Search in book…`,"onUpdate:modelValue":n[12]||=e=>j.value=e},null,512),[[m,j.value]]),h(`div`,rt,[A.value?(c(),_(`span`,it,`Indexing…`)):(c(),_(`span`,at,`Search ready (`+v(Object.keys(i(z)).length)+` chapters`+v(F.value?`, cached`:``)+`)`,1))]),j.value.trim()&&!A.value&&!M.value.length?(c(),_(`div`,ot,` No matches. `)):p(``,!0),M.value.length?(c(),_(`div`,st,[(c(!0),_(te,null,re(M.value,e=>(c(),_(`div`,{key:e.href+e.snippet,class:`p-2 hover:bg-base-200 cursor-pointer`,onClick:t=>{St(e),be()}},[h(`div`,lt,v(e.href),1),h(`div`,ut,v(e.snippet),1)],8,ct))),128))])):p(``,!0)]),_:1},8,[`open`]),e(de,{open:B.value,title:V.value,onClose:jt},{default:s(()=>[W.value?(c(),_(`div`,dt,`Loading…`)):(c(),_(`div`,{key:1,class:`space-y-2`,onClick:Mt,innerHTML:H.value},null,8,ft))]),_:1},8,[`open`,`title`])]))}});export{M as default};